From 1c4766e075382764e7b94208ffa6e1e5322dfa85 Mon Sep 17 00:00:00 2001
From: Alvin Wong <alvin@alvinhc.com>
Date: Sun, 26 Jun 2022 01:59:00 +0800
Subject: [PATCH] Try removing setlocale call with ostream

---
 libcxx/src/support/win32/locale_win32.cpp | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

diff --git a/libcxx/src/support/win32/locale_win32.cpp b/libcxx/src/support/win32/locale_win32.cpp
index 43e5c9a57227..764a7b49ec35 100644
--- a/libcxx/src/support/win32/locale_win32.cpp
+++ b/libcxx/src/support/win32/locale_win32.cpp
@@ -96,11 +96,18 @@ int snprintf_l(char *ret, size_t n, locale_t loc, const char *format, ...)
         _CRT_INTERNAL_LOCAL_PRINTF_OPTIONS | _CRT_INTERNAL_PRINTF_STANDARD_SNPRINTF_BEHAVIOR,
         ret, n, format, loc, ap);
 #else
-    __libcpp_locale_guard __current(loc);
-#pragma clang diagnostic push
-#pragma clang diagnostic ignored "-Wformat-nonliteral"
-    int result = vsnprintf( ret, n, format, ap );
-#pragma clang diagnostic pop
+#  if 1
+    int result = _vsnprintf_s_l(ret, n, _TRUNCATE, format, loc, ap);
+    if (result < 0)
+      result = _vscprintf_l(format, loc, ap);
+#  else
+    int result = _vsnprintf_l(ret, n, format, loc, ap);
+    if (result < 0 || result == n) {
+      ret[n - 1] = '\0';
+      if (result < 0)
+        result = _vscprintf_l(format, loc, ap);
+    }
+#  endif
 #endif
     va_end(ap);
     return result;
-- 
2.36.1

